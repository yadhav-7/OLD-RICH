<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add this in your <head> or before closing </body> -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%);
            min-height: 100vh;
            font-family: Arial, sans-serif;
            color: #1a5d1a;
        }


        .coupon-container {
            background: #ffffff;
            padding: 12px;
            border-radius: 10px;
            font-family: sans-serif;
            position: relative;
            width: 100%;
            max-width: 420px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .coupon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: #2e7d32;
            /* deep green */
        }

        .coupon-header i {
            transition: transform 0.3s;
            color: #2e7d32;
        }

        .coupon-header.active i {
            transform: rotate(180deg);
        }

        .coupon-list {
            display: none;
            margin-top: 10px;
            border: 1px solid #c8e6c9;
            border-radius: 6px;
            background: #f9fff9;
            /* light greenish white */
            max-height: 150px;
            overflow-y: auto;
        }

        .coupon-list div {
            padding: 8px 10px;
            cursor: pointer;
            color: #2e7d32;
            font-size: 14px;
        }

        .coupon-list div:hover {
            background: #e8f5e9;
            /* hover green */
        }

        .coupon-input {
            display: flex;
            margin-top: 10px;
        }

        .coupon-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #c8e6c9;
            border-radius: 6px 0 0 6px;
            outline: none;
            background: #ffffff;
            color: #2e7d32;
        }

        .coupon-input input::placeholder {
            color: #81c784;
        }

        .coupon-input button {
            background: #2e7d32;
            /* green */
            color: #fff;
            border: none;
            padding: 0 6px;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .coupon-input button:hover {
            background: #1b5e20;
            /* darker green */
        }

        .checkout-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 30px auto;
            max-width: 1100px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .premium-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(26, 93, 26, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .premium-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #1a5d1a, #28a745);
        }

        .premium-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a5d1a;
            margin-bottom: 20px;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, #1a5d1a, transparent);
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s ease;
        }

        .cart-item:hover {
            background: rgba(232, 245, 233, 0.2);
            border-radius: 10px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .product-image {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            object-fit: cover;
            margin-right: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .product-image:hover {
            transform: scale(1.05);
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 1rem;
            font-weight: 600;
            color: #1a5d1a;
            margin-bottom: 5px;
        }

        .product-details {
            color: #4a5568;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-badge {
            background: linear-gradient(135deg, #1a5d1a, #28a745);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.75rem;
            margin-right: 15px;
            box-shadow: 0 2px 5px rgba(26, 93, 26, 0.2);
        }

        .product-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a5d1a;
            margin: 0;
        }

        .product-total-price {
            font-size: 0.9rem;
            color: #4a5568;
            margin-top: 3px;
            text-align: right;
        }

        .address-card {
            background: linear-gradient(135deg, #ffffff 0%, #e8f5e9 100%);
            border: 1px solid rgba(26, 93, 26, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }

        .address-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #1a5d1a, #28a745);
            border-radius: 2px;
        }

        .address-card:hover {
            transform: translateX(3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
        }

        .address-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1a5d1a;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .address-details {
            color: #4a5568;
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .address-actions {
            display: flex;
            gap: 8px;
        }

        .btn-premium {
            background: linear-gradient(135deg, #1a5d1a, #28a745);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 4px 8px;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(26, 93, 26, 0.2);
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(26, 93, 26, 0.3);
            color: white;
        }

        .btn-outline-premium {
            background: transparent;
            color: #1a5d1a;
            border: 1px solid #1a5d1a;
            border-radius: 8px;
            padding: 3px 6px;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-outline-premium:hover {
            background: #1a5d1a;
            color: white;
            transform: translateY(-2px);
        }

        .btn-add-address {
            background: linear-gradient(135deg, rgba(232, 245, 233, 0.3), rgba(232, 245, 233, 0.5));
            color: #1a5d1a;
            border: 1px dashed #1a5d1a;
            border-radius: 8px;
            padding: 8px;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-add-address:hover {
            background: linear-gradient(135deg, #1a5d1a, #28a745);
            color: white;
            border-color: transparent;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            font-size: 0.9rem;
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: #1a5d1a;
            padding-top: 15px;
        }

        .summary-total {
            font-size: 1.3rem;
            color: #1a5d1a;
        }

        .coupon-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(226, 232, 240, 0.8);
        }

        .form-control-premium {
            border: 1px solid rgba(26, 93, 26, 0.2);
            border-radius: 8px;
            padding: 7px 10px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-control-premium:focus {
            border-color: #1a5d1a;
            box-shadow: 0 0 0 2px rgba(26, 93, 26, 0.1);
            background: white;
        }

        .proceed-btn {
            background: linear-gradient(135deg, #1a5d1a, #28a745);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(26, 93, 26, 0.2);
            margin-top: 20px;
        }

        .proceed-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(26, 93, 26, 0.3);
            color: white;
        }

        .form-check-input:checked {
            background-color: #1a5d1a;
            border-color: #1a5d1a;
        }

        /* Delivery Options */
        .delivery-options {
            margin-top: 20px;
            padding: 15px;
            background: rgba(232, 245, 233, 0.3);
            border-radius: 10px;
        }

        .delivery-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delivery-option:hover {
            background: rgba(26, 93, 26, 0.1);
        }

        .delivery-option input[type="radio"] {
            margin-right: 10px;
        }

        .delivery-option-label {
            flex: 1;
        }

        .delivery-option-price {
            font-weight: 600;
            color: #1a5d1a;
        }

        /* Modal Styles */
        .modal-premium .modal-content {
            border: none;
            border-radius: 15px;
            overflow: hidden;
        }

        .modal-premium .modal-header {
            background: linear-gradient(135deg, #1a5d1a, #28a745);
            color: white;
            border-bottom: none;
        }

        .modal-premium .modal-footer {
            border-top: none;
            background: #f8f9fa;
        }

        .modal-premium .btn-close {
            filter: invert(1);
        }

        .address-form .form-label {
            font-weight: 500;
            color: #1a5d1a;
        }

        .address-form .form-control {
            border-radius: 8px;
            border: 1px solid rgba(26, 93, 26, 0.2);
        }

        .address-form .form-control:focus {
            border-color: #1a5d1a;
            box-shadow: 0 0 0 2px rgba(26, 93, 26, 0.1);
        }
    </style>
    <%- include('../../views/partials/user/header', {title: 'Your Cart' }) %>
</head>

<body>
    <div class="checkout-container">
        <div class="row">
            <div class="col-lg-8">
                <div class="premium-card">
                    <h4 class="section-title">Your Cart</h4>

                    <input type="hidden" id="selectedItems" value='<%= JSON.stringify(selectedItems) %>'>


                    <% selectedItems.forEach(item=> { %>
                        <% const productId=item.productId||item.product%>
                            <% const product=products.find(p=> p._id.toString() === productId.toString()) %>
                                <% if (product) { %>
                                    <div class="cart-item">
                                        <img class="product-image" src="/Uploads/<%= product.productImage[0] %>">
                                        <div class="product-info">
                                            <h6 class="product-name">
                                                <%= product.productName %>
                                            </h6>
                                            <div class="product-details">
                                                <span>Size: <%= item.size %></span>
                                                <span>Price: ₹<%= (item.price ?? item.finalAmount).toFixed(2) %></span>
                                            </div>
                                        </div>
                                        <div class="quantity-badge">
                                            Qty: <%= item.quantity %>
                                        </div>
                                        <div>
                                            <p class="product-price">
                                                ₹<%= ((item.totalPrice ?? item.finalAmount) ).toFixed(2) %>
                                            </p>

                                            <p class="product-total-price">
                                                <%= item.quantity || 0 %> × ₹ <%= ((item.price ??
                                                        item.finalAmount)).toFixed(2) %>
                                            </p>

                                        </div>
                                    </div>
                                    <% } %>
                                        <% }); %>
                </div>

                <div class="premium-card">
                    <h4 class="section-title">Delivery Address</h4>
                    <% address.forEach((element, index)=> { %>
                        <div class="address-card">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="address"
                                    id="address_<%= element._id %>" value="<%= element._id %>" <%=index===0 ? 'checked'
                                    : '' %>>
                                <label class="address-title" for="address_<%= element._id %>">
                                    <%= index===0 ? 'Default Address' : element.addressType + ' Address' %>
                                </label>
                            </div>

                            <div class="address-details">
                                <strong>
                                    <%= element.name %>
                                </strong><br>
                                <%= element.city %>, <%= element.state %><br>
                                        <%= element.street %><br>
                                            <%= element.pincode %>
                            </div>

                            <div class="address-details">
                                Phone: <%= element.phone %><br>
                                    <% if (element.altPhone) { %>
                                        Alt. Phone: <%= element.altPhone %>
                                            <% } %>
                            </div>

                            <div class="address-actions">
                                <button class="btn btn-outline-premium btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#editAddressModal"
                                    onclick="loadAddressForEdit('<%= element._id %>', '<%= element.name %>', '<%= element.phone %>', '<%= element.altPhone %>', '<%= element.street %>', '<%=element.country%>', '<%= element.city %>', '<%= element.state %>', '<%= element.pincode %>', '<%= element.addressType %>', )">
                                    Edit
                                </button>
                            </div>
                        </div>
                        <% }) %>

                            <button class="btn btn-add-address" data-bs-toggle="modal"
                                data-bs-target="#addAddressModal">ADD NEW ADDRESS</button>
                </div>


                <input type="hidden" id="orderId" value="<%= typeof orderId !== 'undefined' ? orderId : '' %>">



                <div class="premium-card">
                    <h4 class="section-title">Payment Method</h4>
                    <div class="delivery-options">
                        <div class="delivery-option">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="codPayment"
                                value="COD" checked>
                            <label class="delivery-option-label" for="codPayment">
                                <strong>Cash on Delivery (COD)</strong><br>
                                <small>Pay when you receive your order</small>
                            </label>
                        </div>
                        <div class="delivery-option">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="onlinePayment"
                                value="RPAY">
                            <label class="delivery-option-label" for="onlinePayment">
                                <strong>Online Payment</strong><br>
                                <small>Pay now with credit/debit card or UPI</small>
                            </label>
                        </div>


                        <!-- Wallet Payment -->
                        <div class="delivery-option">
                            <% if (cartTotal> walletBalance) { %>
                                <input class="form-check-input" type="radio" name="paymentMethod" id="walletPayment"
                                    value="WALLET" disabled>
                                <label class="delivery-option-label" for="walletPayment">
                                    <strong>Wallet Payment</strong><br>
                                    <small style="color: red;">Insufficient balance</small>
                                </label>
                                <% } else { %>
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="walletPayment"
                                        value="WALLET">
                                    <label class="delivery-option-label" for="walletPayment">
                                        <strong>Wallet Payment</strong><br>
                                        <small>Pay using your wallet balance</small>
                                    </label>
                                    <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="premium-card">
                    <h4 class="section-title">Order Summary</h4>
                    <div class="summary-item">
                        <span>Subtotal (<%= selectedItems?.length%> items)</span>
                        <span>₹<%= cartTotal.toFixed(2) %></span>
                    </div>
                    <div class="summary-item">
                        <span>Savings</span>
                        <span id="savings">-₹<%= savings %></span>

                    </div>
                    <div class="summary-item">
                        <span>Coupon Discount</span>
                        <span id="couponDiscount">-₹0.00</span>
                    </div>
                    <div class="summary-item">
                        <span>Shipping</span>
                        <span>Free Shipping</span>
                    </div>
                    <hr class="my-2">
                    <div class="summary-item">
                        <h5>Total</h5>
                        <h5 class="summary-total" id="totalCart">₹<%= cartTotal?.toFixed(2) %>
                        </h5>
                    </div>



                    <% if(coupons!==null&&coupons.length>0){ %>
                        <div class="coupon-container">
                            <div class="coupon-header" onclick="toggleCouponDropdown()">
                                <span>Apply Coupon</span>
                                <i id="arrow">&#9662;</i>
                            </div>

                            <div class="coupon-list" id="couponList">
                                <% coupons.forEach((cpn)=>{%>
                                    <div onclick="setCoupon('<%= cpn.code %>')">
                                        <%= cpn.name %>
                                    </div>
                                    <% }) %>
                            </div>

                            <div class="coupon-input">
                                <input type="text" id="couponCode" placeholder="Enter coupon code">
                                <button id="" onclick="applyCoupon()">Apply</button>
                            </div>
                        </div>
                        <% } %>
                            <button class="btn proceed-btn w-100" onclick="proceedToPayment('<%= user._id%>')">PLACE
                                ORDER</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Add Address Modal -->
    <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    <form id="addAddressForm" novalidate>
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" pattern="^[a-zA-Z\s]{3,50}$" required>
                            <div class="invalid-feedback" id="nameError">Please enter a valid name (3-50
                                letters, no
                                special characters)</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" pattern="^[\d\s+()-]{7,20}$" required>
                                <div class="invalid-feedback" id="phoneError">Please enter a valid phone number
                                    (7-20 digits)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="altPhone" class="form-label">Alternate Phone (Optional)</label>
                                <input type="tel" class="form-control" id="altPhone" pattern="^[\d\s+()-]{7,20}$|^$">
                                <div class="invalid-feedback" id="altPhoneError">Please enter a valid phone
                                    number
                                    (7-20 digits)</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="addressType" class="form-label">Address Type</label>
                            <select class="form-select" id="addressType" required>
                                <option value="" selected disabled>Select address type</option>
                                <option value="Home">Home</option>
                                <option value="Office">Office</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="invalid-feedback" id="addressTypeError">Please select an address type
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="country" class="form-label">Country</label>
                            <select class="form-select" id="country" required>
                                <option value="" selected disabled>Select country</option>
                                <option value="IN">India</option>
                                <option value="CA">Canada</option>
                                <option value="GB">United Kingdom</option>
                                <option value="AU">Australia</option>
                                <option value="other">Other</option>
                            </select>
                            <div class="invalid-feedback" id="countryError">Please select a country</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" pattern="^[a-zA-Z\s-]{2,50}$"
                                    required>
                                <div class="invalid-feedback" id="stateError">Please enter a valid state name
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" pattern="^[a-zA-Z\s-]{2,50}$"
                                    required>
                                <div class="invalid-feedback" id="cityError">Please enter a valid city name
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="street" class="form-label">Street Address</label>
                                <input type="text" class="form-control" id="street" pattern="^[a-zA-Z0-9\s,.'-]{5,100}$"
                                    required>
                                <div class="invalid-feedback" id="streetError">Please enter a valid street
                                    address
                                    (5-100 characters)</div>
                            </div>
                            <div class="col-md-4">
                                <label for="pincode" class="form-label">Postal/ZIP Code</label>
                                <input type="text" class="form-control" id="pincode" pattern="^[a-zA-Z0-9-]{3,10}$"
                                    required>
                                <div class="invalid-feedback" id="pincodeError">Please enter a valid postal/ZIP
                                    code
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-white">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveAddressBtn">Save Address</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Edit Address Modal -->
    <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    <form id="editAddressForm" novalidate>
                        <input type="hidden" id="editAddressId">
                        <div class="mb-3">
                            <label for="editAddressType" class="form-label">Address Type</label>
                            <select class="form-select" id="editAddressType" required>
                                <option value="" selected disabled>Select address type</option>
                                <option value="Home">Home</option>
                                <option value="Office">Office</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="invalid-feedback" id="editAddressTypeError">Please select an address
                                type
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editName" pattern="^[a-zA-Z\s]{3,50}$" required>
                            <div class="invalid-feedback" id="editNameError">Please enter a valid name (3-50
                                letters, no special characters)</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="editPhone" pattern="^[\d\s+()-]{7,20}$"
                                    required>
                                <div class="invalid-feedback" id="editPhoneError">Please enter a valid phone
                                    number
                                    (7-20 digits)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="editAltPhone" class="form-label">Alternate Phone (Optional)</label>
                                <input type="tel" class="form-control" id="editAltPhone"
                                    pattern="^[\d\s+()-]{7,20}$|^$">
                                <div class="invalid-feedback" id="editAltPhoneError">Please enter a valid phone
                                    number (7-20 digits)</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editCountry" class="form-label">Country</label>
                            <select class="form-select" id="editCountry" required>
                                <option value="" selected disabled>Select country</option>
                                <option value="IN">India</option>
                                <option value="CA">Canada</option>
                                <option value="GB">United Kingdom</option>
                                <option value="AU">Australia</option>
                                <option value="other">Other</option>
                            </select>
                            <div class="invalid-feedback" id="editCountryError">Please select a country</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editState" class="form-label">State</label>
                                <input type="text" class="form-control" id="editState" pattern="^[a-zA-Z\s-]{2,50}$"
                                    required>
                                <div class="invalid-feedback" id="editStateError">Please enter a valid state
                                    name
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="editCity" class="form-label">City</label>
                                <input type="text" class="form-control" id="editCity" pattern="^[a-zA-Z\s-]{2,50}$"
                                    required>
                                <div class="invalid-feedback" id="editCityError">Please enter a valid city name
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="editStreet" class="form-label">Street Address</label>
                                <input type="text" class="form-control" id="editStreet"
                                    pattern="^[a-zA-Z0-9\s,.'-]{5,100}$" required>
                                <div class="invalid-feedback" id="editStreetError">Please enter a valid street
                                    address (5-100 characters)</div>
                            </div>
                            <div class="col-md-4">
                                <label for="editPincode" class="form-label">Postal/ZIP Code</label>
                                <input type="text" class="form-control" id="editPincode" pattern="^[a-zA-Z0-9-]{3,10}$"
                                    required>
                                <div class="invalid-feedback" id="editPincodeError">Please enter a valid
                                    postal/ZIP
                                    code</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-white">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="updateAddress" onclick="updateAddress()">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>


    <script>

        // Valid Indian pincode ranges by state
        const validIndianPincodes = {
            'Andhra Pradesh': { start: 500000, end: 535999 },
            'Arunachal Pradesh': { start: 790000, end: 792999 },
            'Assam': { start: 780000, end: 788999 },
            'Bihar': { start: 800000, end: 855999 },
            'Chhattisgarh': { start: 490000, end: 497999 },
            'Delhi': { start: 110000, end: 110099 },
            'Goa': { start: 403000, end: 403999 },
            'Gujarat': { start: 360000, end: 396999 },
            'Haryana': { start: 120000, end: 136999 },
            'Himachal Pradesh': { start: 170000, end: 177999 },
            'Jammu and Kashmir': { start: 180000, end: 194999 },
            'Jharkhand': { start: 810000, end: 835999 },
            'Karnataka': { start: 560000, end: 591999 },
            'Kerala': { start: 670000, end: 695999 },
            'Ladakh': { start: 194000, end: 194999 },
            'Madhya Pradesh': { start: 450000, end: 488999 },
            'Maharashtra': { start: 400000, end: 445999 },
            'Manipur': { start: 795000, end: 795999 },
            'Meghalaya': { start: 793000, end: 794999 },
            'Mizoram': { start: 796000, end: 796999 },
            'Nagaland': { start: 797000, end: 798999 },
            'Odisha': { start: 750000, end: 770999 },
            'Punjab': { start: 140000, end: 160999 },
            'Rajasthan': { start: 300000, end: 345999 },
            'Sikkim': { start: 737000, end: 737999 },
            'Tamil Nadu': { start: 600000, end: 643999 },
            'Telangana': { start: 500000, end: 509999 },
            'Tripura': { start: 799000, end: 799999 },
            'Uttar Pradesh': { start: 200000, end: 285999 },
            'Uttarakhand': { start: 240000, end: 263999 },
            'West Bengal': { start: 700000, end: 743999 },
            'Puducherry': { start: 605000, end: 609999 },
            'Chandigarh': { start: 160000, end: 160999 },
            'Dadra and Nagar Haveli and Daman and Diu': { start: 396000, end: 396999 },
            'Lakshadweep': { start: 682000, end: 682999 },
            'Andaman and Nicobar Islands': { start: 744000, end: 744999 }
        };

        // Function to validate Indian pincode
        function validateIndianPincode(pincode, state) {
            if (!/^\d{6}$/.test(pincode)) return false;

            const pincodeNum = parseInt(pincode);

            // Invalid pincode patterns
            if (pincodeNum === 123456 || pincodeNum === 0 || pincodeNum === 999999) {
                return false;
            }

            // Check against state-specific ranges
            if (state && validIndianPincodes[state]) {
                const range = validIndianPincodes[state];
                return pincodeNum >= range.start && pincodeNum <= range.end;
            }

            // General validation for any valid Indian pincode range
            const validRanges = [
                { start: 110000, end: 110099 }, // Delhi
                { start: 120000, end: 136999 }, // Haryana
                { start: 140000, end: 160999 }, // Punjab & Chandigarh
                { start: 170000, end: 177999 }, // Himachal Pradesh
                { start: 180000, end: 194999 }, // J&K & Ladakh
                { start: 200000, end: 285999 }, // UP & Uttarakhand
                { start: 300000, end: 345999 }, // Rajasthan
                { start: 360000, end: 396999 }, // Gujarat & Daman Diu
                { start: 400000, end: 445999 }, // Maharashtra
                { start: 450000, end: 497999 }, // MP & Chhattisgarh
                { start: 500000, end: 535999 }, // Andhra Pradesh & Telangana
                { start: 560000, end: 591999 }, // Karnataka
                { start: 600000, end: 643999 }, // Tamil Nadu & Puducherry
                { start: 670000, end: 695999 }, // Kerala & Lakshadweep
                { start: 700000, end: 743999 }, // West Bengal & Andaman
                { start: 744000, end: 744999 }, // Andaman and Nicobar
                { start: 750000, end: 770999 }, // Odisha
                { start: 780000, end: 799999 }, // Northeast states
                { start: 800000, end: 855999 }  // Bihar & Jharkhand
            ];

            return validRanges.some(range => pincodeNum >= range.start && pincodeNum <= range.end);
        }

        // Country-specific validation patterns and data
        const countryData = {
            'IN': {
                name: 'India',
                phonePattern: /^[6-9]\d{9}$/,
                pincodePattern: /^\d{6}$/,
                phoneFormat: '10-digit number starting with 6-9',
                pincodeFormat: 'valid 6-digit Indian pincode',
                states: [
                    'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
                    'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand',
                    'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur',
                    'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab',
                    'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura',
                    'Uttar Pradesh', 'Uttarakhand', 'West Bengal', 'Delhi', 'Jammu and Kashmir',
                    'Ladakh', 'Puducherry', 'Chandigarh', 'Dadra and Nagar Haveli and Daman and Diu',
                    'Lakshadweep', 'Andaman and Nicobar Islands'
                ]
            },
            'US': {
                name: 'United States',
                phonePattern: /^[2-9]\d{2}[2-9]\d{2}\d{4}$/,
                pincodePattern: /^\d{5}(-\d{4})?$/,
                phoneFormat: '10-digit US phone number',
                pincodeFormat: '5-digit ZIP or 9-digit ZIP+4',
                states: [
                    'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado',
                    'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho',
                    'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana',
                    'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
                    'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada',
                    'New Hampshire', 'New Jersey', 'New Mexico', 'New York',
                    'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon',
                    'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota',
                    'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington',
                    'West Virginia', 'Wisconsin', 'Wyoming', 'Washington D.C.'
                ]
            },
            'GB': {
                name: 'United Kingdom',
                phonePattern: /^(\+44|0)?[1-9]\d{8,9}$/,
                pincodePattern: /^[A-Z]{1,2}\d[A-Z\d]?\s?\d[A-Z]{2}$/i,
                phoneFormat: 'UK phone number (11 digits)',
                pincodeFormat: 'UK postcode format',
                states: [
                    'England', 'Scotland', 'Wales', 'Northern Ireland'
                ]
            },
            'CA': {
                name: 'Canada',
                phonePattern: /^[2-9]\d{2}[2-9]\d{2}\d{4}$/,
                pincodePattern: /^[A-Z]\d[A-Z]\s?\d[A-Z]\d$/i,
                phoneFormat: '10-digit Canadian phone number',
                pincodeFormat: 'Canadian postal code (A1A 1A1)',
                states: [
                    'Alberta', 'British Columbia', 'Manitoba', 'New Brunswick',
                    'Newfoundland and Labrador', 'Northwest Territories', 'Nova Scotia',
                    'Nunavut', 'Ontario', 'Prince Edward Island', 'Quebec',
                    'Saskatchewan', 'Yukon'
                ]
            },
            'AU': {
                name: 'Australia',
                phonePattern: /^(\+61|0)?[2-478]\d{8}$/,
                pincodePattern: /^\d{4}$/,
                phoneFormat: 'Australian phone number',
                pincodeFormat: '4-digit postcode',
                states: [
                    'Australian Capital Territory', 'New South Wales', 'Northern Territory',
                    'Queensland', 'South Australia', 'Tasmania', 'Victoria', 'Western Australia'
                ]
            }
        };

        // Helper function for status badge
        function getStatusBadgeClass(status) {
            switch (status.toLowerCase()) {
                case 'delivered': return 'badge-delivered';
                case 'shipped': return 'badge-shipped';
                case 'completed': return 'badge-completed';
                case 'processing': return 'badge bg-info';
                case 'cancelled': return 'badge bg-danger';
                default: return 'badge bg-secondary';
            }
        }

        // Enhanced validation patterns with country support
        const patterns = {
            username: /^[a-zA-Z]{3,20}$/,
            name: /^[a-zA-Z\s]{2,50}$/,
            street: /^[a-zA-Z0-9\s,.'-]{5,100}$/,
            city: /^[a-zA-Z\s-]{2,50}$/,
            bio: /^.{0,200}$/
        };

        // Get country-specific validation data
        function getCountryValidation(countryCode) {
            return countryData[countryCode] || countryData['IN']; // Default to India
        }

        // Enhanced error messages with country context
        function getErrorMessage(fieldId, countryCode = 'IN') {
            const countryInfo = getCountryValidation(countryCode);

            const messages = {
                username: 'Username must be 3-20 letters only, no numbers or special characters',
                phone: `Please enter a valid ${countryInfo.phoneFormat}`,
                altPhone: `Please enter a valid ${countryInfo.phoneFormat}`,
                name: 'Please enter a valid name (2-50 letters only)',
                state: `Please select a valid state/province for ${countryInfo.name}`,
                city: 'Please enter a valid city name (2-50 characters)',
                street: 'Please enter a valid street address (5-100 characters)',
                pincode: `Please enter a valid ${countryInfo.pincodeFormat}`,
                bio: 'Bio cannot exceed 200 characters'
            };
            return messages[fieldId] || 'Invalid input';
        }

        // Enhanced field validation with country support
        function validateField(field) {
            const fieldId = field.id.replace('edit', '').toLowerCase();
            const errorElement = document.getElementById(`${field.id}Error`);
            const value = field.value.trim();

            // Get country code from country select field
            const countrySelect = document.getElementById(field.id.includes('edit') ? 'editCountry' : 'country');
            const countryCode = countrySelect ? countrySelect.value : 'IN';
            const countryInfo = getCountryValidation(countryCode);

            // Phone validation with country-specific patterns
            if (fieldId === 'phone' || fieldId === 'editphone') {
                if (!countryInfo.phonePattern.test(value)) {
                    showFieldError(field, errorElement, `Enter a valid ${countryInfo.phoneFormat}`);
                    return false;
                }
            }
            // Alternative phone validation (optional field)
            else if (fieldId === 'altphone' || fieldId === 'editaltphone') {
                if (value && !countryInfo.phonePattern.test(value)) {
                    showFieldError(field, errorElement, `Enter a valid ${countryInfo.phoneFormat}`);
                    return false;
                }
            }
            // Pincode validation with country-specific patterns
            else if (fieldId === 'pincode' || fieldId === 'editpincode') {
                if (countryCode === 'IN') {
                    // Get the state for better validation
                    const stateSelect = document.getElementById(field.id.includes('edit') ? 'editState' : 'state');
                    const selectedState = stateSelect ? stateSelect.value : '';

                    if (!countryInfo.pincodePattern.test(value)) {
                        showFieldError(field, errorElement, 'Enter a valid 6-digit pincode');
                        return false;
                    }

                    if (!validateIndianPincode(value, selectedState)) {
                        const errorMsg = selectedState
                            ? `Enter a valid pincode for ${selectedState}`
                            : 'Enter a valid Indian pincode (e.g., 110001, 400001, 700001)';
                        showFieldError(field, errorElement, errorMsg);
                        return false;
                    }
                } else {
                    if (!countryInfo.pincodePattern.test(value)) {
                        showFieldError(field, errorElement, `Enter a valid ${countryInfo.pincodeFormat}`);
                        return false;
                    }
                }
            }
            // State validation
            else if (fieldId === 'state' || fieldId === 'editstate') {
                if (!countryInfo.states.includes(value)) {
                    showFieldError(field, errorElement, `Please select a valid state for ${countryInfo.name}`);
                    return false;
                }
            }
            // Username validation (letters only)
            else if (fieldId === 'username' || fieldId === 'editusername') {
                if (!patterns.username.test(value)) {
                    showFieldError(field, errorElement, 'Username must be 3-20 letters only');
                    return false;
                }
            }
            // Name validation
            else if (fieldId === 'name' || fieldId === 'editname') {
                if (!patterns.name.test(value)) {
                    showFieldError(field, errorElement, 'Name must be 2-50 letters only');
                    return false;
                }
            }
            // City validation
            else if (fieldId === 'city' || fieldId === 'editcity') {
                if (!patterns.city.test(value)) {
                    showFieldError(field, errorElement, 'City name must be 2-50 letters only');
                    return false;
                }
            }
            // Street validation
            else if (fieldId === 'street' || fieldId === 'editstreet') {
                if (!patterns.street.test(value)) {
                    showFieldError(field, errorElement, 'Street address must be 5-100 characters');
                    return false;
                }
            }
            // Required field validation
            else if (field.required && !value) {
                showFieldError(field, errorElement, 'This field is required');
                return false;
            }

            // Field is valid
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
            errorElement.style.display = 'none';
            return true;
        }

        // Helper function to show field errors
        function showFieldError(field, errorElement, message) {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
            errorElement.style.display = 'block';
            errorElement.textContent = message;
        }

        // Update state dropdown based on country selection
        function updateStateOptions(countrySelectId, stateSelectId) {
            const countrySelect = document.getElementById(countrySelectId);
            const stateSelect = document.getElementById(stateSelectId);

            if (!countrySelect || !stateSelect) return;

            const countryCode = countrySelect.value;
            const countryInfo = getCountryValidation(countryCode);

            // Clear existing options
            stateSelect.innerHTML = '<option value="">Select State/Province</option>';

            // Add new options
            countryInfo.states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });

            // Reset validation state
            stateSelect.classList.remove('is-valid', 'is-invalid');
            const errorElement = document.getElementById(`${stateSelectId}Error`);
            if (errorElement) errorElement.style.display = 'none';
        }

        // Validate select field
        function validateSelect(select) {
            const selectId = select.id;
            const errorElement = document.getElementById(`${selectId}Error`);
            if (select.required && !select.value) {
                select.classList.add('is-invalid');
                select.classList.remove('is-valid');
                errorElement.style.display = 'block';
                errorElement.textContent = 'Please select an option';
                return false;
            }
            select.classList.remove('is-invalid');
            select.classList.add('is-valid');
            errorElement.style.display = 'none';
            return true;
        }

        // Validate entire form
        function validateForm(form) {
            let isValid = true;
            const inputs = form.querySelectorAll('input[pattern], input[required]');
            const selects = form.querySelectorAll('select[required]');
            inputs.forEach(input => { isValid &= validateField(input); });
            selects.forEach(select => { isValid &= validateSelect(select); });
            return isValid;
        }

        // Show alert



        window.retryPayment = <%= JSON.stringify(typeof retryPayment !== 'undefined' ? retryPayment : false) %>;
        const orderId = document.getElementById('orderId').value



        console.log('retryPayment:', window.retryPayment);
        console.log('orderId:', window.orderId)


        function toggleCouponDropdown() {
            const list = document.getElementById("couponList");
            const arrow = document.getElementById("arrow");
            list.style.display = list.style.display === "block" ? "none" : "block";
            arrow.parentElement.classList.toggle("active");
        }

        function setCoupon(code) {
            document.getElementById("couponCode").value = code;
            document.getElementById("couponList").style.display = "none";
        }
        let alreadyApplied = false
        let couponDiscount = null
        async function applyCoupon() {
            try {
                if (alreadyApplied) {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'warning',
                        title: 'Coupon already applied',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                    return;
                }

                const code = document.getElementById("couponCode").value
                let savings = document.getElementById('savings').textContent


                if (!code) {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'warning',
                        title: 'Please enter or select a coupon',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                    return;
                }

                const response = await fetch('/applyCoupon', {
                    method: 'post',
                    headers: {
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        code,
                        savings
                    })
                })
                let result = await response.json()
                if (response.ok) {

                    couponDiscount = result.couponDiscount
                    document.getElementById('savings').textContent = result.savings
                    document.getElementById('couponDiscount').textContent = result.couponDiscount
                    document.getElementById('totalCart').textContent = result.totalCart
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: result.message || `Coupon applied: ${code}`,
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    })
                    alreadyApplied = true
                } else {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'warning',
                        title: result.message || 'Something went wrong!',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    })

                }
            } catch (error) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'warning',
                    title: error.message || 'Something went wrong!',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
            }
        }

        // Calculate and update order summary
        function updateOrderSummary() {
            // In this version, the calculations are done server-side and rendered directly
            // But we keep this function for potential client-side updates
            const subtotal = subtotal
            let discount = 0;
            let couponDiscount = 0;

            // Check if express delivery is selected
            const expressDelivery = document.querySelector('input[name="deliveryOption"]:checked').value === 'express';
            const shippingCost = expressDelivery ? 99 : 0;

            const total = subtotal - discount - couponDiscount + shippingCost;

            document.querySelector('.summary-item:nth-child(1) span:last-child').textContent = `₹${subtotal.toFixed(2)}`;
            document.querySelector('.summary-item:nth-child(2) span:last-child').textContent = `-₹${discount.toFixed(2)}`;
            document.querySelector('.summary-item:nth-child(3) span:last-child').textContent = `-₹${couponDiscount.toFixed(2)}`;
            document.querySelector('.summary-item:nth-child(4) span:last-child').textContent =
                shippingCost > 0 ? `₹${shippingCost.toFixed(2)}` : 'Free Shipping';
            document.querySelector('.summary-total').textContent = `₹${total.toFixed(2)}`;
        }

        // Load address data into edit modal
        function loadAddressForEdit(id, name, phone, altPhone, street, editCountry, city, state, pincode, addressType, isDefault) {
            document.getElementById('editAddressId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editPhone').value = phone;
            document.getElementById('editAltPhone').value = altPhone || '';
            document.getElementById('editStreet').value = street;
            document.getElementById('editCity').value = city;
            document.getElementById('editState').value = state;
            document.getElementById('editCountry').value = editCountry
            document.getElementById('editPincode').value = pincode;
            document.getElementById('editAddressType').value = addressType;
            document.getElementById('editIsDefault').checked = isDefault === 'true';
        }


        // Get the save button and form
        const saveBtn = document.getElementById('saveAddressBtn');
        const addressForm = document.getElementById('addAddressForm');
        const editAddressForm = document.getElementById('editAddressForm')

        // Add click event listener to the save button
        saveBtn.addEventListener('click', function () {

            // Check alternate phone if provided
            const altPhone = document.getElementById('altPhone');
            if (altPhone.value && !/^\d{10}$/.test(altPhone.value)) {
                altPhone.classList.add('is-invalid');
                isValid = false;
            }


            if (saveBtn) {

                    if (!validateForm(addAddressForm)) {
                        const firstError = addAddressForm.querySelector('.is-invalid');
                        if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return;
                    }


             

                saveAddress()
            } else {
                // Scroll to the first invalid field
                const firstInvalid = addressForm.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
            }
        });

        // Add input event listeners to clear validation when user types
        addressForm.querySelectorAll('input, textarea, select').forEach(field => {
            field.addEventListener('input', function () {
                if (this.classList.contains('is-invalid')) {
                    this.classList.remove('is-invalid');
                }
            });
        });

        async function saveAddress() {
            const addressData = {
                name: document.getElementById('name').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                altPhone: document.getElementById('altPhone').value.trim(),
                addressType: document.getElementById('addressType').value,
                country: document.getElementById('country').value,
                state: document.getElementById('state').value.trim(),
                city: document.getElementById('city').value.trim(),
                street: document.getElementById('street').value.trim(),
                pincode: document.getElementById('pincode').value.trim(),
            };

            try {
                const response = await fetch('/addAddress', {
                    method: 'post',
                    headers: {
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify(addressData)
                });

                const result = await response.json(); // Make sure to await this

                if (response.ok) {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: result.message || 'Address added successfully!',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        background: '#eaffea',
                        color: '#155724',
                    });



                    window.location.reload()

                    document.getElementById('addAddressForm').reset();


                } else {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: result.message || 'Something went wrong...',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        background: '#ffeaea',
                        color: '#721c24',
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'error',
                    title: 'Network error occurred',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    background: '#ffeaea',
                    color: '#721c24',
                });
            }
        }

        async function updateAddress() {


            const updateAddressBtn = document.getElementById('updateAddress');


            if (!validateForm(editAddressForm)) {

                const firstError = editAddressForm.querySelector('.is-invalid');
                if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }






            const addAddressId = document.getElementById('editAddressId').value;

            const addressData = {
                addressType: document.getElementById('editAddressType').value,
                name: document.getElementById('editName').value,
                street: document.getElementById('editStreet').value,
                city: document.getElementById('editCity').value,
                state: document.getElementById('editState').value,
                pincode: document.getElementById('editPincode').value,
                country: document.getElementById('editCountry').value,
                phone: document.getElementById('editPhone').value,
                altPhone: document.getElementById('editAltPhone').value
            };

            try {
                console.log('Sending request to backend with data:', addressData);

                const response = await fetch(`/editAddress?addressId=${encodeURIComponent(addAddressId)}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(addressData)
                });

                console.log('Received response, checking status...');

                const result = await response.json(); // May throw error if response is not JSON

                if (response.ok) {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: result.message || 'Edited successfully!',
                        showConfirmButton: false,
                        timer: 2000
                    });

                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAddressModal'));
                    modal?.hide();
                    window.location.reload();

                } else {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: result.message || 'Failed to update address!',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }

            } catch (error) {
                console.error('Fetch failed or response not JSON:', error);
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'error',
                    title: 'Something went wrong!!!',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            updateOrderSummary();

            // Listen for delivery option changes
            document.querySelectorAll('input[name="deliveryOption"]').forEach(radio => {
                radio.addEventListener('change', updateOrderSummary);
            });

            // Listen for payment method changes
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'cod') {
                        alert('Cash on Delivery selected. You will pay when you receive your order.');
                    } else {
                        alert('Online Payment selected. You will be redirected to payment gateway.');
                    }
                });
            });
        });

        async function proceedToPayment(userId) {

            let totalCart = document.getElementById('totalCart').textContent
            totalCart = totalCart.split('').slice(1).join('')

            totalCart = parseInt(totalCart)

            let code = null
                <% if (coupons !== null && coupons.length > 0) { %>
                    code = document.getElementById("couponCode").value
                        <% } %>
                       
            const selectedItemsRaw = document.getElementById('selectedItems').value
            const selectedItems = JSON.parse(selectedItemsRaw)
            try {
                const selectedAddress = document.querySelector('input[name="address"]:checked')?.value
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value
                if (!selectedAddress || !paymentMethod) {

                    Swal.fire('Missing Info', 'Please select both address and payment method.', 'warning')
                    return
                }

                const data = {
                    addressId: selectedAddress,
                    paymentMethod: paymentMethod,
                    selectedItems: selectedItems,
                    couponApplied: alreadyApplied,
                    code: code,
                    couponDiscount: couponDiscount,
                    retryPayment: window.retryPayment,
                    orderId
                }
                alert('data.code',data.code)
                console.log('data.code',data.code)

                if (paymentMethod === 'COD' || paymentMethod === 'WALLET') {
                    if (paymentMethod === 'COD' && totalCart >= 1000) return Toastify({
                        text: ' Order above Rs 1000 not be allowed for COD',
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                        stopOnFocus: true,
                        close: true,
                        className: "rounded-xl shadow-md font-semibold",
                    }).showToast()

                    const response = await fetch('/procedToCheckOut', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })

                    const result = await response.json()
                    let orderId = result.orderId
                    if (response.ok) {
                        window.location.href = `/orderSuccess?orderId=${encodeURIComponent(orderId)}`;
                    } else {
                        Toastify({
                            text: result.message || "Something went wrong!",
                            duration: 3000,
                            gravity: "top", // top or bottom
                            position: "right", // left, center or right
                            backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)", // red-orange error tone
                            stopOnFocus: true,
                            close: true,
                            className: "rounded-xl shadow-md font-semibold",
                        }).showToast();

                    }
                } else if (paymentMethod === 'RPAY') {


                    let retryPayment = window.retryPayment

                    let endpoint = retryPayment !== true ? '/create-razorpay-order' : '/reCreateRazorpayOrder'

                    fetch(endpoint, {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                        .then(res => res.json())
                        .then(order => {
                            if (!order || !order.orderId) {


                                let data = { message: 'Failed to initiate razorpay payment' }
                                Toastify({
                                    text: data.message || "No orders found",
                                    duration: 3000,
                                    gravity: "top",
                                    position: "center",
                                    backgroundColor: "linear-gradient(to right, #ff9966, #ff5e62)",
                                    stopOnFocus: true,
                                }).showToast();

                                return;
                            } else {
                                const options = {
                                    key: "<%= razorpayKeyId %>",
                                    amount: order.amount,
                                    currency: order.currency,
                                    name: "OLDRICH",
                                    description: "Order Payment",
                                    order_id: order.orderId,
                                    handler: async function (response) {
                                        try {

                                            console.log("Razorpay Success Response:", response);

                                            const verifyRes = await fetch("/verify-razorpay-payment", {
                                                method: "POST",
                                                headers: { "Content-Type": "application/json" },
                                                body: JSON.stringify({
                                                    razorpay_payment_id: response.razorpay_payment_id,
                                                    razorpay_order_id: response.razorpay_order_id,
                                                    razorpay_signature: response.razorpay_signature,
                                                    selectedItems,
                                                    userId,
                                                    address: selectedAddress,
                                                    couponApplied: data.couponApplied,
                                                    couponCode: code,
                                                }),
                                            });

                                            const verifyData = await verifyRes.json();

                                            if (verifyData.success) {


                                                window.location.href = `/orderSuccess?orderId=${encodeURIComponent(verifyData.orderId)}`
                                            } else {

                                                window.location.href = `paymentFaildPage?data=${encodeURIComponent(data)}`
                                            }

                                        } catch (err) {
                                            console.error('Error during verification:', err);
                                            Toastify({
                                                text: "Something went wrong during checkout",
                                                duration: 4000,
                                                gravity: "top",          // top or bottom
                                                position: "center",      // left, center or right
                                                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                                                stopOnFocus: true
                                            }).showToast();

                                        }
                                    }
                                }
                                const rzp = new Razorpay(options)
                                rzp.open()

                                rzp.on('payment.failed', () => {
                                    window.location.href = `paymentFaildPage?razorPayOrderId=${encodeURIComponent(order.orderId)}`
                                })

                            }
                        })
                        .catch(err => console.error("Order creation failed:", err));

                }
            } catch (err) {
                console.error('Payment Error:', err);
                Swal.fire('Failed', 'Please try again later.', 'error')
            }
        }

    </script>
</body>

</html>