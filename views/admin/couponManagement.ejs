<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coupon Management</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="icon" href="/adminTitleIcon/Gemini_Generated_Image_19c76t19c76t19c7.png" type="image/png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root {
            --yellow-900: #8a6d00;
            --yellow-800: #b38f00;
            --yellow-700: #cc9a00;
            --yellow-600: #e6ac00;
            --yellow-500: #ffc107;
            --yellow-400: #ffca28;
            --yellow-300: #ffd54f;
            --yellow-200: #ffe082;
            --yellow-100: #ffecb3;
            --yellow-50: #fff8e1;
            --white: #ffffff;
            --bg: #fffef9;
            --text: #1a1a1a;
            --muted: #6b6b6b;
            --border: #e6e6e6;
            --shadow: 0 12px 30px rgba(0, 0, 0, 0.07);
            --radius: 14px;
        }

        * {
            box-sizing: border-box
        }

        .report-section {
            display: block !important; /* Override any inline display:none */
        }

        .error {
            color: #d32f2f;
            font-size: 12px;
            display: block;
            margin-top: 3px;
            min-height: 15px;
        }

        body {
            height: 100%;
            margin: 0;
            font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.45;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff9e6;
            padding: 10px 20px;
            border-radius: 8px;
            gap: 10px;
            font-family: Arial, sans-serif;
        }

        .pagination button {
            background: var(--yellow-600);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .pagination button:hover {
            background: var(--yellow-700);
        }

        .pagination .page-box {
            background: #fff3cd;
            color: var(--yellow-900);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
        }

        .pagination span {
            color: var(--yellow-900);
            font-size: 16px;
            font-weight: 600;
        }

        a {
            color: inherit;
            text-decoration: none
        }

        img {
            max-width: 100%
        }

        .hero-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .hero-title {
            margin: 0 0 6px 0;
            font-weight: 800;
            letter-spacing: .5px;
            font-size: 32px;
        }

        .hero-sub {
            margin: 0;
            color: #fffef9;
            opacity: .95;
        }

        /* Main section */
        .main {
            max-width: 1089px;
            margin: 20px auto;
            padding: 48px 0px;
            margin-left: 15rem;
        }

        .card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        /* Action bar */
        .action-bar {
            padding: 18px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .search-wrap {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center
        }

        .search-form {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input {
            height: 44px;
            min-width: 260px;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #ffffff;
            outline: none;
            color: #111827;
            transition: border .2s, box-shadow .2s;
        }

        .input:focus {
            border-color: var(--yellow-400);
            box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.15);
        }

        .btn {
            height: 44px;
            padding: 0 16px;
            border-radius: 12px;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform .08s ease, background .2s, border .2s;
            user-select: none;
        }

        .btn:active {
            transform: translateY(1px)
        }

        .btn-primary {
            background: var(--yellow-600);
            color: #fff;
            border-color: var(--yellow-600)
        }

        .btn-primary:hover {
            background: var(--yellow-700)
        }

        .btn-ghost {
            background: #ffffff;
            border-color: var(--border);
            color: #1f2937
        }

        .btn-ghost:hover {
            border-color: #cbd5e1;
            background: #f8faf9
        }

        .btn-outline {
            background: var(--yellow-50);
            color: var(--yellow-800);
            border-color: var(--yellow-300);
        }

        .btn-outline:hover {
            background: #fff9e6;
            border-color: var(--yellow-400);
        }

        .spacer {
            flex: 1
        }

        /* Table */
        .table-wrap {
            padding: 16px
        }

        .table-scroll {
            overflow: auto;
            border-radius: 12px;
            border: 1px solid var(--border)
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #fff
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: #fff9e6;
            border-bottom: 1px solid var(--yellow-300);
            color: var(--yellow-900);
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: .3px;
            padding: 14px 14px;
        }

        tbody td {
            padding: 14px 14px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            font-size: 14px;
        }

        tbody tr:last-child td {
            border-bottom: none
        }

        tbody tr:hover td {
            background: #fffef9
        }

        .code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            background: #fff9e6;
            border: 1px dashed var(--yellow-300);
            border-radius: 8px;
            padding: 4px 8px;
            color: var(--yellow-900);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 700;
            border-radius: 999px;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .badge.success {
            background: var(--yellow-50);
            color: var(--yellow-800);
            border-color: var(--yellow-300)
        }

        .badge.inactive {
            background: #f9f9f9;
            color: #6b6b6b;
            border-color: #e6e6e6
        }

        .badge.expired {
            background: #f9f9f9;
            color: #6b6b6b;
            border-color: #e6e6e6
        }

        .badge.public {
            background: #fff9e6;
            color: var(--yellow-900);
            border-color: var(--yellow-300)
        }

        .badge.private {
            background: #f9f9f9;
            color: #6b6b6b;
            border-color: #e6e6e6
        }

        .amount,
        .min {
            font-weight: 700;
            color: var(--yellow-900)
        }

        .muted {
            color: var(--muted)
        }

        .usage {
            font-weight: 700;
            color: var(--yellow-800)
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn-small {
            height: 36px;
            padding: 0 12px;
            border-radius: 10px;
            font-size: 13px;
            width: 4rem;
        }

        .btn-soft {
            background: #ffffff;
            border-color: var(--yellow-300);
            color: var(--yellow-900);
        }

        .btn-soft:hover {
            background: #fff9e6;
            border-color: var(--yellow-400)
        }

        .btn-neutral {
            background: #ffffff;
            border-color: #e6e6e6;
            color: #6b6b6b;
        }

        .btn-neutral:hover {
            background: #f9f9f9;
            border-color: #dbe1e8
        }

        /* Pagination */
        .pagination {
            padding: 14px 18px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center
        }

        .page-list {
            display: flex;
            gap: 8px;
            list-style: none;
            margin: 0;
            padding: 0
        }

        .page-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            padding: 0 12px;
            border-radius: 10px;
            border: 1px solid var(--yellow-300);
            background: var(--white);
            color: var(--yellow-900);
            font-weight: 700;
            transition: background .2s, border .2s, transform .08s ease;
        }

        .page-link:hover {
            background: #fff9e6;
            border-color: var(--yellow-400)
        }

        .page-link.active {
            background: var(--yellow-600);
            border-color: var(--yellow-600);
            color: #fff;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 700;
            font-size: 18px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--muted);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--yellow-500);
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.15);
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Responsive helpers */
        @media (max-width: 1024px) {
            .main {
                margin-left: 0;
                padding: 20px;
            }
        }

        @media (max-width: 720px) {
            .input {
                min-width: unset;
                width: 100%
            }

            .search-form {
                width: 100%
            }

            .action-bar {
                align-items: stretch
            }

            .spacer {
                display: none
            }

            thead th:nth-child(3),
            thead th:nth-child(4),
            thead th:nth-child(6),
            thead th:nth-child(9) {
                display: none;
            }

            tbody td:nth-child(3),
            tbody td:nth-child(4),
            tbody td:nth-child(6),
            tbody td:nth-child(9) {
                display: none;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .actions {
                flex-direction: column;
            }

            .btn-small {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .main {
                padding: 10px;
            }
            
            .action-bar {
                padding: 12px;
            }
            
            .table-wrap {
                padding: 8px;
            }
            
            .modal-content {
                width: 95%;
            }
        }
    </style>
</head>

<body>
    <!-- Include admin headers and sidebar -->
    <%- include('../../views/partials/admin/adminHeaders', {title: 'adminHeader-page' }) %>
    <%- include('../../views/partials/admin/adminSidebar', {title: 'adminSidebar-page' }) %>

    <!-- Main Content -->
    <main class="main">
        <section class="card" aria-labelledby="couponListHeading">
            <div class="action-bar">
                <h2 id="couponListHeading" class="sr-only">Coupon List</h2>
                <div class="search-wrap">
                    <form class="search-form" action="#" role="search" aria-label="Search coupons">
                        <input id="searchInput" class="input" type="text" name="query"
                            placeholder="Search coupons..." aria-label="Search coupons" />
                        <button id="searchResetBtn" class="btn btn-ghost" type="reset">Reset</button>
                        <button id="searchBtn" class="btn btn-outline" type="submit">Search</button>
                    </form>
                </div>
                <div class="spacer" aria-hidden="true"></div>
                <div>
                    <button class="btn btn-primary" id="addCouponBtn">+ Add New Coupon</button>
                </div>
            </div>

            <div class="table-wrap">
                <div class="table-scroll">
                    <table aria-describedby="couponListHeading">
                        <caption class="sr-only">List of coupons</caption>
                        <thead>
                            <tr>
                                <th scope="col">Coupon Name</th>
                                <th scope="col">Code</th>
                                <th scope="col">Created Date</th>
                                <th scope="col">Expire Date</th>
                                <th scope="col">Expire Time</th>
                                <th scope="col">Offer Price</th>
                                <th scope="col">Min Amount</th>
                                <th scope="col">Status</th>
                                <th scope="col">Visibility</th>
                                <th scope="col">Maximum Count</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <% coupons.forEach((cpn,index)=> { %>
                                <tr id="row-<%= cpn.code %>">
                                    <td class="c-name"><%= cpn.name %></td>
                                    <td class="c-code"><span class="code"><%= cpn.code %></span></td>

                                    <td class="c-created">
                                        <%= new Date(cpn.createdOn).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" }) %>
                                    </td>

                                    <td class="c-expire-date">
                                        <%= new Date(cpn.expireOn).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" }) %>
                                    </td>

                                    <td class="c-expire-time">
                                        <%= new Date(cpn.expireOn).toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" }) %>
                                    </td>

                                    <td class="c-amount">₹<%= cpn.amount %></td>
                                    <td class="c-min">₹<%= cpn.minimumPrice %></td>

                                    <td class="c-status">
                                        <% if (new Date(cpn.expireOn) < currentDate) { %>
                                            <span class="badge expired" style="color:#d32f2f">Expired</span>
                                        <% } else { %>
                                            <span class="badge valid" style="color:#388e3c">Valid</span>
                                        <% } %>
                                    </td>

                                    <td class="c-visible">
                                        <span class="badge private" id="visibleStatus<%= cpn.code %>">
                                            <%= cpn.isList ? "Public" : "Private" %>
                                        </span>
                                    </td>

                                    <td class="c-max"><%= cpn.maxUsage %></td>

                                    <td class="actions">
                                        <button class="btn btn-soft btn-small edit-btn" data-id="<%= cpn._id %>" data-code="<%= cpn.code %>">Edit</button>

                                        <% if(cpn.isList){ %>
                                            <button class="btn btn-neutral btn-small list-btn" data-id="<%= cpn.code %>" data-status="private">unList</button>
                                        <% } else { %>
                                            <button class="btn btn-neutral btn-small list-btn" data-id="<%= cpn.code %>" data-status="Public">List</button>
                                        <% } %>

                                        <button class="btn btn-neutral btn-small delete-btn" data-id="<%= cpn.code %>">Delete</button>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <% if(currentPage>1){ %>
                        <button onclick="pagination('<%= currentPage %>','previous')">&#9664;</button>
                    <% } %>
                    <div id="currentPage" class="page-box">
                        <%= currentPage %>
                    </div>
                    <span>of <%= totalPage %></span>
                    <% if(currentPage < totalPage){ %>
                        <button onclick="pagination('<%= currentPage %>','next')">&#9654;</button>
                    <% } %>
                </div>
            </div>
        </section>
    </main>

    <!-- Add Coupon Modal -->
    <div class="modal" id="couponModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Coupon</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="couponForm">
                    <input type="hidden" id="couponId" value="">
                    <div class="form-group">
                        <label for="name" class="form-label">Coupon Name</label>
                        <input type="text" id="name" class="form-input" >
                        <small id="nameError" class="error"></small>
                    </div>
                    <div class="form-group">
                        <label for="code" class="form-label">Coupon Code</label>
                        <input type="text" id="code" class="form-input" >
                        <small id="codeError" class="error"></small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amount" class="form-label">Discount Amount (₹)</label>
                            <input type="number" id="amount" class="form-input" min="0" >
                            <small id="amountError" class="error"></small>
                        </div>
                        <div class="form-group">
                            <label for="minimumPrice" class="form-label">Minimum Cart Value (₹)</label>
                            <input type="number" id="minimumPrice" class="form-input" min="0" >
                            <small id="minimumPriceError" class="error"></small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maxUsage" class="form-label">Maximum Usage</label>
                            <input type="number" id="maxUsage" class="form-input" min="1" >
                            <small id="maxUsageError" class="error"></small>
                        </div>
                        <div class="form-group">
                            <label for="isList" class="form-label">Visibility</label>
                            <select id="isList" class="form-input" >
                                <option value="true">Public</option>
                                <option value="false">Private</option>
                            </select>
                            <small id="isListError" class="error"></small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expireOn" class="form-label">Expiry Date</label>
                        <input type="datetime-local" id="expireOn" class="form-input" >
                        <small id="expireOnError" class="error"></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="saveCouponBtn">Save Coupon</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const addCouponBtn = document.getElementById('addCouponBtn');
        const couponModal = document.getElementById('couponModal');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveCouponBtn = document.getElementById('saveCouponBtn');
        const couponForm = document.getElementById('couponForm');
        const modalTitle = document.getElementById('modalTitle');
        const couponId = document.getElementById('couponId');
        const tableBody = document.getElementById('tableBody');
        const searchForm = document.querySelector('.search-form');
        const searchInput = document.getElementById('searchInput');
        const searchResetBtn = document.getElementById('searchResetBtn');
        const currentPageElement = document.getElementById('currentPage');

        // Event Listeners for Modal
        addCouponBtn.addEventListener('click', () => {
            couponForm.reset();
            clearErrors();
            couponId.value = '';
            modalTitle.textContent = 'Add New Coupon';
            couponModal.classList.add('show');
        });

        closeModal.addEventListener('click', () => {
            couponModal.classList.remove('show');
        });

        cancelBtn.addEventListener('click', () => {
            couponModal.classList.remove('show');
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === couponModal) {
                couponModal.classList.remove('show');
            }
        });

        // Clear error messages when user starts typing
        document.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('input', function() {
                const errorId = this.id + 'Error';
                const errorElement = document.getElementById(errorId);
                if (errorElement) {
                    errorElement.textContent = '';
                }
            });
        });

        // Save Coupon
        saveCouponBtn.addEventListener("click", async () => {
            try {
                // Browser validation
                if (!couponForm.checkValidity()) {
                    couponForm.reportValidity();
                    return;
                }

                const isAdd = modalTitle.textContent === "Add New Coupon";
                const isEdit = modalTitle.textContent === "Edit Coupon";

                // Collect fields
                const formValues = {
                    name: document.getElementById("name").value,
                    code: document.getElementById("code").value,
                    amount: parseFloat(document.getElementById("amount").value),
                    minimumPrice: parseFloat(document.getElementById("minimumPrice").value),
                    maxUsage: parseInt(document.getElementById("maxUsage").value),
                    isList: document.getElementById("isList").value === "true",
                    expireOn: new Date(document.getElementById("expireOn").value)
                };

                const errors = validateCouponForm();
                const isValid = displayErrors(errors);
                if (!isValid) return;

                // --------------------------
                //  ADD NEW COUPON
                // --------------------------
                if (isAdd) {
                    const response = await fetch(`/admin/addCoupon?page=${encodeURIComponent(1)}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ formData: formValues })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        return Swal.fire({
                            toast: true,
                            position: "top-end",
                            icon: "error",
                            title: result.message || "Failed to add!",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }

                    Toastify({
                        text: "Coupon added successfully!",
                        duration: 1500,
                        gravity: "top",
                        position: "right",
                        style: {
                            background: "linear-gradient(to right, #ffc107, #ffd54f)",
                            color: "#1a1a1a",
                            fontWeight: "500",
                            borderRadius: "8px",
                            padding: "10px 16px"
                        }
                    }).showToast();

                    // Add the new coupon row to the table
                    addCouponRow(result.coupon);

                    // Close modal
                    couponModal.classList.remove("show");
                    return;
                }

                // --------------------------
                //  EDIT COUPON
                // --------------------------
                if (isEdit) {
                    const couponData = {
                        name: formValues.name,
                        code: formValues.code,
                        amount: formValues.amount,
                        minimumPrice: formValues.minimumPrice,
                        maxUsage: formValues.maxUsage,
                        isList: document.getElementById("isList").value === "true",
                        expireOn: document.getElementById("expireOn").value
                    };

                    const response = await fetch(
                        `/admin/editCoupon?id=${encodeURIComponent(couponId.value)}`,
                        {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ couponData })
                        }
                    );

                    const result = await response.json();

                    couponModal.classList.remove("show");

                    if (!response.ok) {
                        return Toastify({
                            text: result.message || "Update failed",
                            duration: 4000,
                            gravity: "top",
                            position: "right",
                            style: {
                                background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                                color: "#fff",
                                fontWeight: "500",
                                borderRadius: "8px",
                                padding: "10px 16px"
                            }
                        }).showToast();
                    }

                    Toastify({
                        text: "Coupon updated successfully!",
                        duration: 1500,
                        gravity: "top",
                        position: "right",
                        style: {
                            background: "linear-gradient(to right, #ffc107, #ffd54f)",
                            color: "#1a1a1a",
                            fontWeight: "500",
                            borderRadius: "8px",
                            padding: "10px 16px"
                        }
                    }).showToast();

                    // Update table row using the new clean function
                    updateCouponRow(result.updatedCoupon);

                    return;
                }

            } catch (error) {
                Toastify({
                    text: "Something went wrong, please try again later!",
                    duration: 5000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                        color: "#fff",
                        padding: "16px",
                        borderRadius: "8px"
                    }
                }).showToast();
            }
        });

        function addCouponRow(coupon) {
            const tbody = document.getElementById("tableBody");

            const createdDate = new Date(coupon.createdOn).toLocaleDateString("en-GB", {
                day: "2-digit", month: "short", year: "numeric"
            });

            const expireDate = new Date(coupon.expireOn).toLocaleDateString("en-GB", {
                day: "2-digit", month: "short", year: "numeric"
            });

            const expireTime = new Date(coupon.expireOn).toLocaleTimeString("en-GB", {
                hour: "2-digit", minute: "2-digit"
            });

            // Check if we need to maintain only 3 coupons per page
            const currentRows = tbody.querySelectorAll('tr');
            if (currentRows.length >= 3) {
                // Remove the last row to maintain only 3 coupons
                currentRows[currentRows.length - 1].remove();
            }

            tbody.insertAdjacentHTML("afterbegin", `
                <tr id="row-${coupon.code}">
                    <td class="c-name">${coupon.name}</td>
                    <td class="c-code"><span class="code">${coupon.code}</span></td>
                    <td class="c-created">${createdDate}</td>
                    <td class="c-expire-date">${expireDate}</td>
                    <td class="c-expire-time">${expireTime}</td>
                    <td class="c-amount">₹${coupon.amount}</td>
                    <td class="c-min">₹${coupon.minimumPrice}</td>
                    <td class="c-status">
                        <span class="badge ${new Date(coupon.expireOn) < new Date() ? "expired" : "valid"}"
                            style="color:${new Date(coupon.expireOn) < new Date() ? "#d32f2f" : "#388e3c"}">
                            ${new Date(coupon.expireOn) < new Date() ? "Expired" : "Valid"}
                        </span>
                    </td>
                    <td class="c-visible">
                        <span id="visibleStatus${coupon.code}" class="badge private">
                            ${coupon.isList ? "Public" : "Private"}
                        </span>
                    </td>
                    <td class="c-max">${coupon.maxUsage}</td>
                    <td class="actions">
                        <button class="btn btn-soft btn-small edit-btn" data-id="${coupon._id}" data-code="${coupon.code}">Edit</button>
                        <button class="btn btn-neutral btn-small list-btn"
                                data-id="${coupon.code}" data-status="${coupon.isList ? "private" : "Public"}">
                            ${coupon.isList ? "unList" : "List"}
                        </button>
                        <button class="btn btn-neutral btn-small delete-btn" data-id="${coupon.code}">Delete</button>
                    </td>
                </tr>
            `);
        }

        function updateCouponRow(coupon) {
            const row = document.getElementById(`row-${coupon.code}`);
            if (!row) return;

            row.querySelector(".c-name").textContent = coupon.name;
            row.querySelector(".c-code span").textContent = coupon.code;

            row.querySelector(".c-created").textContent =
                new Date(coupon.createdOn).toLocaleDateString("en-GB", {
                    day: "2-digit", month: "short", year: "numeric"
                });

            row.querySelector(".c-expire-date").textContent =
                new Date(coupon.expireOn).toLocaleDateString("en-GB", {
                    day: "2-digit", month: "short", year: "numeric"
                });

            row.querySelector(".c-expire-time").textContent =
                new Date(coupon.expireOn).toLocaleTimeString("en-GB", {
                    hour: "2-digit", minute: "2-digit"
                });

            row.querySelector(".c-amount").textContent = `₹${coupon.amount}`;
            row.querySelector(".c-min").textContent = `₹${coupon.minimumPrice}`;

            // Status
            const statusSpan = row.querySelector(".c-status span");
            const expired = new Date(coupon.expireOn) < new Date();

            statusSpan.textContent = expired ? "Expired" : "Valid";
            statusSpan.style.color = expired ? "#d32f2f" : "#388e3c";

            // Visibility
            row.querySelector(".c-visible span").textContent = coupon.isList ? "Public" : "Private";

            // Max usage
            row.querySelector(".c-max").textContent = coupon.maxUsage;
        }

        function clearErrors() {
            document.querySelectorAll(".error").forEach(el => el.textContent = "");
        }

        function displayErrors(errors) {
            clearErrors();

            let hasError = false;

            if (errors.name) {
                document.getElementById("nameError").textContent = errors.name;
                hasError = true;
            }
            if (errors.code) {
                document.getElementById("codeError").textContent = errors.code;
                hasError = true;
            }
            if (errors.amount) {
                document.getElementById("amountError").textContent = errors.amount;
                hasError = true;
            }
            if (errors.minimumPrice) {
                document.getElementById("minimumPriceError").textContent = errors.minimumPrice;
                hasError = true;
            }
            if (errors.maxUsage) {
                document.getElementById("maxUsageError").textContent = errors.maxUsage;
                hasError = true;
            }
            if (errors.isList) {
                document.getElementById("isListError").textContent = errors.isList;
                hasError = true;
            }
            if (errors.expireOn) {
                document.getElementById("expireOnError").textContent = errors.expireOn;
                hasError = true;
            }

            return !hasError; // true if valid, false if errors
        }

        function validateCouponForm() {
            const errors = {
                name: "",
                code: "",
                amount: "",
                minimumPrice: "",
                maxUsage: "",
                isList: "",
                expireOn: ""
            };

            const name = document.getElementById('name').value.trim();
            const code = document.getElementById('code').value.trim().toUpperCase();
            const amount = document.getElementById('amount').value.trim();
            const minimumPrice = document.getElementById('minimumPrice').value.trim();
            const maxUsage = document.getElementById('maxUsage').value.trim();
            const isList = document.getElementById('isList').value;
            const expireOn = document.getElementById('expireOn').value.trim();

            if (!name) {
                errors.name = "Name is required.";
            } else if (name.length < 3 || name.length > 10) {
                errors.name = "Name must be 3–10 characters.";
            } else if (!/[a-zA-Z]/.test(name)) {
                errors.name = "Name must contain at least one alphabet.";
            }

            const codeRe = /^[A-Z0-9_-]{3,10}$/;
            if (!code) errors.code = "Code is required.";
            else if (!codeRe.test(code)) errors.code = "Code must be 3–10 chars (A-Z, 0-9, _, -).";

            if (amount === "") errors.amount = "Amount is required.";
            else if (isNaN(amount) || Number(amount) < 0) errors.amount = "Amount must be a number ≥ 0.";
            else if (Number(amount) >= Number(minimumPrice)) {
                errors.amount = "Discount Price cannot be equal or more than Minimum Cart value";
            }

            // minimumPrice → number ≥ 0
            if (minimumPrice === "") errors.minimumPrice = "Minimum Price is required.";
            else if (isNaN(minimumPrice) || Number(minimumPrice) < 0) errors.minimumPrice = "Minimum Price must be ≥ 0.";

            // maxUsage → integer ≥ 1
            if (maxUsage === "") errors.maxUsage = "Max Usage is required.";
            else if (!Number.isInteger(Number(maxUsage)) || Number(maxUsage) < 1)
                errors.maxUsage = "Max Usage must be an integer ≥ 1.";

            // isList → must be true/false
            if (isList !== "true" && isList !== "false") {
                errors.isList = "Please select Public or Private.";
            }

            // expireOn → valid future date
            if (!expireOn) {
                errors.expireOn = "Expire date is required.";
            } else {
                const expDate = new Date(expireOn);
                if (isNaN(expDate.getTime())) {
                    errors.expireOn = "Expire date must be valid.";
                } else if (expDate <= new Date()) {
                    errors.expireOn = "Expire date must be in the future.";
                }
            }

            return errors;
        }

        // Event Delegation for dynamically created buttons
        document.querySelector('tbody').addEventListener('click', function (e) {
            // Edit button handling
            if (e.target.classList.contains('edit-btn')) {
                const row = e.target.closest("tr");
                const couponData = {
                    id: e.target.dataset.id,
                    name: row.querySelector("td:nth-child(1)").textContent.trim(),
                    code: row.querySelector(".code").textContent.trim(),
                    createdOn: row.querySelector("td:nth-child(3)").textContent.trim(),
                    expireOn: row.querySelector("td:nth-child(4)").textContent.trim(),
                    expireOnTime: row.querySelector("td:nth-child(5)").textContent.trim(),
                    amount: row.querySelector(".c-amount").textContent.replace("₹", "").trim(),
                    minimumPrice: row.querySelector(".c-min").textContent.replace("₹", "").trim(),
                    maxUsage: row.querySelector(".c-max").textContent.trim(),
                    isList: row.querySelector("[id^='visibleStatus']").textContent.trim() === "Public"
                };

                // Populate the form
                document.getElementById('name').value = couponData.name;
                document.getElementById('code').value = couponData.code;
                document.getElementById('amount').value = couponData.amount;
                document.getElementById('minimumPrice').value = couponData.minimumPrice;
                document.getElementById('maxUsage').value = couponData.maxUsage;
                document.getElementById('isList').value = couponData.isList ? "true" : "false";

                // Split the date part ("15 Sep 2025")
                const [day, monthName, year] = couponData.expireOn.split(" ");

                // Get the time part ("05:35" or similar)
                const time = couponData.expireOnTime;

                const monthMap = {
                    "Jan": "01", "Feb": "02", "Mar": "03", "Apr": "04",
                    "May": "05", "Jun": "06", "Jul": "07", "Aug": "08",
                    "Sep": "09", "Sept": "09",  // include both to be safe
                    "Oct": "10", "Nov": "11", "Dec": "12"
                };

                // Format the date for datetime-local input (YYYY-MM-DDTHH:MM)
                const formattedDate = `${year}-${monthMap[monthName]}-${day.padStart(2, "0")}T${time.slice(0, 5)}`;

                document.getElementById('expireOn').value = formattedDate;

                couponId.value = couponData.id;

                // Update modal title and show
                modalTitle.textContent = 'Edit Coupon';
                couponModal.classList.add('show');
            }

            // Delete button handling
            else if (e.target.classList.contains('delete-btn')) {
                const code = e.target.getAttribute('data-id');
                const row = e.target.closest('tr');
                const couponName = row.querySelector('td:first-child').textContent;

                // Your existing delete logic here
                (async () => {
                    const { isConfirmed } = await Swal.fire({
                        title: 'Are you sure?',
                        text: `You are about to delete the coupon "${couponName}". This action cannot be undone.`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: 'Yes, delete it!'
                    });

                    if (isConfirmed) {
                        const response = await fetch(`/admin/deleteCoupon?code=${encodeURIComponent(code)}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            row.remove();
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: 'Coupon deleted successfully',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true
                            });
                        } else {
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'error',
                                title: 'Something went wrong!',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true
                            });
                        }
                    }
                })();
            }

            // List/Unlist button handling
            else if (e.target.classList.contains('list-btn')) {
                const code = e.target.getAttribute('data-id');
                const visibleStatus = document.getElementById(`visibleStatus${code}`);
                const currentStatus = e.target.getAttribute('data-status');

                // Your existing list/unlist logic here
                (async () => {
                    try {
                        const action = currentStatus === 'private' ? 'List' : 'unList';
                        const { isConfirmed } = await Swal.fire({
                            title: `Are you sure?`,
                            text: `Do you want to ${action} this coupon?`,
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonText: `Yes, ${action}`,
                            cancelButtonText: "Cancel",
                            reverseButtons: true
                        });

                        if (isConfirmed) {
                            const response = await fetch(`/admin/listUnlistCoupon?code=${encodeURIComponent(code)}`);
                            if (response.ok) {
                                e.target.setAttribute("data-status", currentStatus === "private" ? "Public" : "private");
                                e.target.textContent = currentStatus === 'private' ? 'unList' : 'List';
                                visibleStatus.textContent = currentStatus === 'private' ? 'Public' : 'Private';
                            } else {
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'error',
                                    title: 'Something went wrong!',
                                    showConfirmButton: false,
                                    timer: 2000,
                                    timerProgressBar: true
                                });
                            }
                        }
                    } catch (error) {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'error',
                            title: 'Something went wrong!',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true
                        });
                    }
                })();
            }
        });

        async function pagination(currentPage, btn) {
            try {
                currentPage = parseInt(currentPage);
                let page = btn === 'next' ? currentPage + 1 : currentPage - 1;
                let query = document.getElementById('searchInput').value

                const response = await fetch(`/admin/getCouponPage?page=${encodeURIComponent(page)}&search=${encodeURIComponent(query)}`, {
                    headers: { "Accept": "application/json" }
                });

                if (response.ok) {
                    const result = await response.json();

                    let rows = result.coupons.map(cpn => {
                        const dateObj = new Date(cpn.expireOn);

                        // Format time in 24-hour HH:MM
                        const timeStr = dateObj.toLocaleTimeString("en-GB", {
                            hour: "2-digit",
                            minute: "2-digit"
                        });

                        return `
                            <tr id="row-${cpn.code}">
                                <td>${cpn.name}</td>
                                <td><span class="code">${cpn.code}</span></td>
                                <td>${new Date(cpn.createdOn).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })}</td>
                                <td>${new Date(cpn.expireOn).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })}</td>
                                <td>
                                    <span>${timeStr}</span>
                                </td>
                                <td class="c-amount">₹${cpn.amount}</td>
                                <td class="c-min">₹${cpn.minimumPrice}</td>
                                <td>
                                    ${new Date(cpn.expireOn) < new Date(result.currentDate)
                                        ? '<span class="badge expired" style="color:#d32f2f;">Expired</span>'
                                        : '<span class="badge expired" style="color:#388e3c;">Valid</span>'
                                    }
                                </td>
                                <td>
                                    ${cpn.isList
                                        ? `<span id="visibleStatus${cpn.code}" class="badge private">Public</span>`
                                        : `<span id="visibleStatus${cpn.code}" class="badge private">Private</span>`
                                    }
                                </td>
                                <td><span class="c-max">${cpn.maxUsage}</span></td>
                                <td class="actions">
                                    <button class="btn btn-soft btn-small edit-btn" data-id="${cpn._id}" data-code="${cpn.code}">Edit</button>
                                    ${cpn.isList
                                        ? `<button class="btn btn-neutral btn-small list-btn" data-id="${cpn.code}" data-status="private">unList</button>`
                                        : `<button class="btn btn-neutral btn-small list-btn" data-id="${cpn.code}" data-status="Public">List</button>`
                                    }
                                    <button class="btn btn-neutral btn-small delete-btn" data-id="${cpn.code}">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join("");

                    tableBody.innerHTML = rows;

                    const paginationDiv = document.querySelector(".pagination");
                    let paginationHTML = "";

                    if (result.currentPage > 1) {
                        paginationHTML += `<button onclick="pagination(${result.currentPage}, 'previous')">&#9664;</button>`;
                    }

                    paginationHTML += `
                        <div class="page-box">${result.currentPage}</div>
                        <span>of ${result.totalPage}</span>
                    `;

                    if (result.currentPage < result.totalPage) {
                        paginationHTML += `<button onclick="pagination(${result.currentPage}, 'next')">&#9654;</button>`;
                    }

                    paginationDiv.innerHTML = paginationHTML;

                } else {
                    alert("its not ok");
                }
            } catch (error) {
                console.error(error);
            }
        }

        // Handle search form submission
        searchForm.addEventListener('submit', async function (e) {
            e.preventDefault()
            try {
                const searchValue = searchInput.value.trim()
                const currentPage = currentPageElement.textContent.trim()

                const response = await fetch(`/admin/getCouponPage?search=${encodeURIComponent(searchValue)}&page=${encodeURIComponent(currentPage)}`, {
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    let rows = result.coupons.map(cpn => {
                        const dateObj = new Date(cpn.expireOn);
                        const timeStr = dateObj.toLocaleTimeString("en-GB", {
                            hour: "2-digit",
                            minute: "2-digit"
                        });

                        return `
                            <tr id="row-${cpn.code}">
                                <td>${cpn.name}</td>
                                <td><span class="code">${cpn.code}</span></td>
                                <td>${new Date(cpn.createdOn).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })}</td>
                                <td>${new Date(cpn.expireOn).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })}</td>
                                <td>
                                    <span>${timeStr}</span>
                                </td>
                                <td class="c-amount">₹${cpn.amount}</td>
                                <td class="c-min">₹${cpn.minimumPrice}</td>
                                <td>
                                    ${new Date(cpn.expireOn) < new Date(result.currentDate)
                                        ? '<span class="badge expired" style="color:#d32f2f;">Expired</span>'
                                        : '<span class="badge expired" style="color:#388e3c;">Valid</span>'
                                    }
                                </td>
                                <td>
                                    ${cpn.isList
                                        ? `<span id="visibleStatus${cpn.code}" class="badge private">Public</span>`
                                        : `<span id="visibleStatus${cpn.code}" class="badge private">Private</span>`
                                    }
                                </td>
                                <td><span class="c-max">${cpn.maxUsage}</span></td>
                                <td class="actions">
                                    <button class="btn btn-soft btn-small edit-btn" data-id="${cpn._id}" data-code="${cpn.code}">Edit</button>
                                    ${cpn.isList
                                        ? `<button class="btn btn-neutral btn-small list-btn" data-id="${cpn.code}" data-status="private">unList</button>`
                                        : `<button class="btn btn-neutral btn-small list-btn" data-id="${cpn.code}" data-status="Public">List</button>`
                                    }
                                    <button class="btn btn-neutral btn-small delete-btn" data-id="${cpn.code}">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join("");

                    tableBody.innerHTML = rows;

                    const paginationDiv = document.querySelector(".pagination");
                    let paginationHTML = "";

                    if (result.currentPage > 1) {
                        paginationHTML += `<button onclick="pagination(${result.currentPage}, 'previous')">&#9664;</button>`;
                    }

                    paginationHTML += `
                        <div class="page-box">${result.currentPage}</div>
                        <span>of ${result.totalPage}</span>
                    `;

                    if (result.currentPage < result.totalPage) {
                        paginationHTML += `<button onclick="pagination(${result.currentPage}, 'next')">&#9654;</button>`;
                    }

                    paginationDiv.innerHTML = paginationHTML;
                } else {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: 'Failed to fetch coupons!',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                }
            } catch (error) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'error',
                    title: 'Something went wrong!',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
                console.error('Search error:', error);
            }
        });

        // Handle reset button
        searchResetBtn.addEventListener('click', async function (e) {
            e.preventDefault()
            try {
                if (!searchInput.value) return
                const searchValue = ''
                searchInput.value = ''
                const currentPage = currentPageElement.textContent.trim()

                const response = await fetch(`/admin/getCouponPage?search=${encodeURIComponent(searchValue)}&page=${encodeURIComponent(currentPage)}`, {
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    let rows = result.coupons.map(cpn => {
                        const dateObj = new Date(cpn.expireOn);
                        const timeStr = dateObj.toLocaleTimeString("en-GB", {
                            hour: "2-digit",
                            minute: "2-digit"
                        });

                        return `
                            <tr id="row-${cpn.code}">
                                <td>${cpn.name}</td>
                                <td><span class="code">${cpn.code}</span></td>
                                <td>${new Date(cpn.createdOn).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })}</td>
                                <td>${new Date(cpn.expireOn).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })}</td>
                                <td>
                                    <span>${timeStr}</span>
                                </td>
                                <td class="c-amount">₹${cpn.amount}</td>
                                <td class="c-min">₹${cpn.minimumPrice}</td>
                                <td>
                                    ${new Date(cpn.expireOn) < new Date(result.currentDate)
                                        ? '<span class="badge expired" style="color:#d32f2f;">Expired</span>'
                                        : '<span class="badge expired" style="color:#388e3c;">Valid</span>'
                                    }
                                </td>
                                <td>
                                    ${cpn.isList
                                        ? `<span id="visibleStatus${cpn.code}" class="badge private">Public</span>`
                                        : `<span id="visibleStatus${cpn.code}" class="badge private">Private</span>`
                                    }
                                </td>
                                <td><span class="c-max">${cpn.maxUsage}</span></td>
                                <td class="actions">
                                    <button class="btn btn-soft btn-small edit-btn" data-id="${cpn._id}" data-code="${cpn.code}">Edit</button>
                                    ${cpn.isList
                                        ? `<button class="btn btn-neutral btn-small list-btn" data-id="${cpn.code}" data-status="private">unList</button>`
                                        : `<button class="btn btn-neutral btn-small list-btn" data-id="${cpn.code}" data-status="Public">List</button>`
                                    }
                                    <button class="btn btn-neutral btn-small delete-btn" data-id="${cpn.code}">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join("");

                    tableBody.innerHTML = rows;

                    const paginationDiv = document.querySelector(".pagination");
                    let paginationHTML = "";

                    if (result.currentPage > 1) {
                        paginationHTML += `<button onclick="pagination(${result.currentPage}, 'previous')">&#9664;</button>`;
                    }

                    paginationHTML += `
                        <div class="page-box">${result.currentPage}</div>
                        <span>of ${result.totalPage}</span>
                    `;

                    if (result.currentPage < result.totalPage) {
                        paginationHTML += `<button onclick="pagination(${result.currentPage}, 'next')">&#9654;</button>`;
                    }

                    paginationDiv.innerHTML = paginationHTML;
                } else {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: 'Failed to fetch coupons!',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                }
            } catch (error) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'error',
                    title: 'Something went wrong!',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
                console.error('Search error:', error);
            }
        });
    </script>
</body>

</html>